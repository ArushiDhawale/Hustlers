<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CycleSync - Private Journal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
    <style> 
        body { font-family: 'Nunito', sans-serif; background-color: #faf5ff; } 
        /* Custom scrollbar for chat */
        #chatMessages::-webkit-scrollbar { width: 4px; }
        #chatMessages::-webkit-scrollbar-thumb { background: #d8b4fe; border-radius: 10px; }
    </style>
</head>
<body class="flex flex-col min-h-screen text-gray-800">

    <div id="toast-container" class="fixed bottom-5 left-5 z-[100] space-y-3"></div>

    <header class="bg-purple-500 text-white shadow-md sticky top-0 z-50">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <a href="index.html" class="flex items-center space-x-2">
                <i class="fas fa-moon text-2xl"></i>
                <h1 class="text-2xl font-bold tracking-wide">CycleSync</h1>
            </a>
            <nav class="hidden md:flex space-x-6 text-purple-100 font-semibold">
                <a href="index.html" class="hover:text-white transition">Home</a>
                <a href="calendar.html" class="hover:text-white transition">Calendar</a>
                <a href="education.html" class="hover:text-white transition">Education</a>
                <a href="support.html" class="hover:text-white transition">Support</a>
                <a href="journal.html" class="text-white border-b-2 border-white">Journal</a>
            </nav>
        </div>
    </header>

    <main class="flex-grow container mx-auto px-4 py-8 flex gap-6">
        
        <div class="flex-grow max-w-2xl">
            <div class="flex justify-between items-end mb-6">
                <div>
                    <h2 class="text-3xl font-bold text-purple-800">My Journal</h2>
                    <p class="text-gray-500 text-sm mt-1"><i class="fas fa-lock mr-1"></i> Private & local.</p>
                </div>
            </div>

            <div class="bg-white rounded-2xl shadow-xl p-6 border border-purple-50">
                <input type="text" id="entryTitle" placeholder="Title..." class="w-full text-xl font-bold mb-4 border-b focus:outline-none focus:border-purple-500 pb-2 bg-transparent placeholder-gray-300">
                <textarea id="entryContent" class="w-full h-48 p-4 bg-purple-50 rounded-xl border-none focus:ring-2 focus:ring-purple-200 resize-none text-gray-700" placeholder="How are you feeling?"></textarea>
                <div class="mt-4 flex justify-end">
                    <button onclick="saveEntry()" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-6 rounded-lg shadow transition transform hover:scale-105">
                        <i class="fas fa-save mr-2"></i> Save Entry
                    </button>
                </div>
            </div>
        </div>

        <aside class="hidden lg:flex flex-col w-80 bg-white rounded-2xl shadow-xl border border-purple-100 overflow-hidden" style="height: 600px;">
            <div class="bg-purple-600 p-4 text-white">
                <h3 class="font-bold flex items-center"><i class="fas fa-users mr-2"></i> Anonymous Community</h3>
                <select id="roomSelect" onchange="joinCommunity()" class="mt-2 w-full bg-purple-500 text-sm border-none rounded p-1 focus:ring-0 cursor-pointer">
                    <option value="General">General Chat</option>
                    <option value="Support">Peer Support</option>
                    <option value="Tips">Daily Tips</option>
                </select>
            </div>
            
            <div id="chatMessages" class="flex-grow p-4 overflow-y-auto text-sm space-y-3 bg-gray-50">
                <p class="text-gray-400 italic text-center">Select a room to start chatting anonymously...</p>
            </div>

            <div class="p-3 border-t">
                <div class="flex gap-2">
                    <input type="text" id="chatInput" placeholder="Say something..." class="flex-grow text-xs p-2 border rounded-lg focus:outline-purple-500">
                    <button onclick="sendMsg()" class="text-purple-600 hover:scale-110 transition">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </aside>
    </main>

    <div id="smartModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-[200] hidden items-center justify-center p-4">
        <div class="bg-white rounded-3xl p-8 max-w-sm w-full shadow-2xl text-center">
            <div class="w-20 h-20 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-4 text-purple-600 text-3xl">
                <i class="fas fa-heart"></i>
            </div>
            <h3 id="modalTitle" class="text-xl font-bold text-gray-800 mb-2"></h3>
            <p id="modalBody" class="text-gray-600 mb-6 text-sm"></p>
            <div class="flex flex-col gap-3">
                <a href="comfort.html" class="bg-purple-600 text-white py-3 rounded-xl font-bold hover:bg-purple-700 transition">Go to Comfort Zone</a>
                <button onclick="closeModal()" class="text-gray-400 text-sm hover:text-gray-600">Maybe later</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
        // --- CHAT LOGIC ---
        const socket = io('http://localhost:3000'); 
        let currentRoom = "General";

        function joinCommunity() {
            currentRoom = document.getElementById('roomSelect').value;
            document.getElementById('chatMessages').innerHTML = `<p class="text-center text-purple-400">Joined ${currentRoom}</p>`;
            socket.emit('join_community', currentRoom);
        }

        function sendMsg() {
            const input = document.getElementById('chatInput');
            if(input.value.trim()) {
                socket.emit('send_chat', { room: currentRoom, message: input.value });
                input.value = '';
            }
        }

        socket.on('receive_chat', (data) => {
            const msgHtml = `<div class="bg-white p-2 rounded-lg shadow-sm border-l-4 border-purple-400">
                <span class="block font-bold text-[10px] text-purple-600">${data.user}</span>
                <span class="text-gray-700">${data.text}</span>
            </div>`;
            const container = document.getElementById('chatMessages');
            container.innerHTML += msgHtml;
            container.scrollTop = container.scrollHeight;
        });

        // --- TOAST NOTIFICATIONS ---
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            const colors = { success: 'bg-green-500', info: 'bg-purple-600', warning: 'bg-amber-500' };

            toast.className = `${colors[type]} text-white px-6 py-3 rounded-xl shadow-lg transform transition-all duration-500 translate-y-10 opacity-0 flex items-center gap-3`;
            toast.innerHTML = `<i class="fas fa-bell"></i> <span>${message}</span>`;
            container.appendChild(toast);

            setTimeout(() => toast.classList.remove('translate-y-10', 'opacity-0'), 100);
            setTimeout(() => {
                toast.classList.add('opacity-0', 'translate-y-[-20px]');
                setTimeout(() => toast.remove(), 500);
            }, 4000);
        }

        // --- SMART MODAL LOGIC ---
        function showSmartModal(title, body) {
            document.getElementById('modalTitle').innerText = title;
            document.getElementById('modalBody').innerText = body;
            const modal = document.getElementById('smartModal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closeModal() {
            const modal = document.getElementById('smartModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        // --- JOURNAL LOGIC ---
        function saveEntry() {
            const title = document.getElementById('entryTitle').value;
            const content = document.getElementById('entryContent').value;

            if (title.trim() || content.trim()) {
                showToast("Journal entry saved locally!", "success");
                checkKeywords(content);
            } else {
                showToast("Please write something before saving.", "warning");
            }
        }

        function checkKeywords(text) {
            const lowerText = text.toLowerCase();
            const triggers = ['pain', 'cramps', 'sad', 'anxious', 'stress', 'hurt'];
            if (triggers.some(word => lowerText.includes(word))) {
                setTimeout(() => {
                    showSmartModal(
                        "Sending some virtual comfort...", 
                        "We noticed you mentioned feeling some discomfort. Would you like to visit the Comfort Zone for a moment?"
                    );
                }, 1000);
            }
        }
    </script>
</body>
</html>